High‑Resolution Drum Transcription Plan (v1)
===========================================

Owner: chart‑hero
Status: Proposed (ready to execute)
Last updated: [auto]

Goals
- Accurately detect kick/snare and fast stickings (32nd/64th/128th where musically present) with tight timing and manageable FPs.
- Substantially reduce tom false positives while improving tom recall on tom‑heavy songs.
- Improve cymbal recall (hi‑hat/crash/ride) without flooding FPs.
- Median timing offsets |median| < 5 ms across classes on a representative dev set.

Key Ideas
- Increase temporal resolution end‑to‑end (feature hop, inference step, loss tolerance).
- Train on thousands of real charts as supervised labels with offset correction and label dilation.
- Use an onset auxiliary head (any‑drum) to gate class predictions; optional offset regression for sub‑frame timing.
- Evaluate with IOI‑binned recall and subdivision recall to verify 32nd/64th coverage.

Resolution Choices
------------------

Baseline (Hi‑res, default)
- hop_length=128 (≈5.8 ms/frame)
- patch_size=(8,16), patch_stride=1 (≈5.8 ms step)
- n_fft=1024 (≈46 ms window) or 512 (≈23 ms) for less temporal smearing vs the current 2048 (~93 ms)
- Covers: 64ths up to ~240 BPM (15.6 ms spacing) with margin; many 128th flams/drags captured with offset refinement

Micro mode (extreme passages)
- hop_length=64 (≈2.9 ms/frame)
- patch_size=(8,16), patch_stride=1 (≈2.9 ms step)
- n_fft=512 (≈23 ms) or 384 (~17 ms equivalent via zero‑pad) to avoid excessive smearing
- Usage: short windows or specific sections flagged by a first‑pass scan; or an alternate model/preset

Decode knobs by mode
- Baseline 5.8 ms: NMS k≈9–11; activity_gate≈0.55–0.65; min spacing (kick/snare)=25–35 ms; cymbal thresholds moderate.
- Micro 2.9 ms: NMS k≈17–21; activity_gate≈0.65–0.75; stronger min spacing (kick/snare)=28–40 ms; higher cymbal and ride thresholds to avoid floods.

Why not always 2.9 ms?
- Quadratic attention cost rises with sequence length; more ticks increase FPs and make noisy charts more painful. Micro mode targets the few sections that need it while keeping training/inference tractable.

Data Source (existing)
- `artifacts/clonehero_charts_json/**.midi.json` generated by `scripts/export_clonehero_drums_archives.py`.
  - Each JSON has: original chart/midi `path`, `timing` tempos (tpq/us_per_beat), and per‑difficulty `events` with 8‑class `hit` and `time_sec`.
  - The original chart/audio live in the same song folder as `path` (contains `drums.ogg` and/or stems and `song.ogg`).

Milestones & Deliverables
1) Metrics & Evaluator upgrades (deliverable: evaluator reports)
   - IOI‑binned recall/precision: compute per‑class recall vs inter‑onset‑interval buckets (≤10, ≤20, ≤30, … ms).
   - Subdivision recall: using the song BPM/tempo map, compute recall at target subdivisions (16th/32nd/64th/128th windows).
   - Constant per‑class offset correction learned on dev; apply during evaluation.
   - Output CSV and pretty summary; keep current summary for continuity.

2) High‑Resolution Config & Inference (deliverable: config + CLI)
   - New config `local_highres`:
     - `hop_length=128` (≈5.8 ms), `patch_size=(8,16)`, `patch_stride=1`, `event_tolerance_patches=3`, `label_dilation_frames=3`.
     - `use_focal_loss=True`, `focal_alpha=0.25`, `focal_gamma=2.0`.
     - Cap auto `pos_weight` to e.g., ≤10.
   - Inference presets:
     - conservative: strong NMS, higher activity gate, higher cym/ride thresholds.
     - aggressive: lower gate/thresholds for editing assistance.

3) Dataset Builder from CH JSON (deliverable: `python -m chart_hero.train.build_dataset`)
   - Input: one or more roots of `**/*.midi.json`.
   - Locate audio root: `song_dir = Path(doc["path"]).parent`.
   - Audio selection priority:
     1. `drums.ogg`
     2. `drums_1.ogg`/`drums_2.ogg`/`drums_3.ogg` mixed equally
     3. `song.ogg`
     4. optional: Demucs drums from `song.ogg` (behind a flag)
   - Alignment:
     - Compute onset envelope from chosen audio (same hop as training) and from chart onsets; find global offset via cross‑correlation; store `offset_sec`.
     - Validate drift: if multiple tempo segments, recompute envelope vs tempo‑warped chart; drop files with excessive residual (>30 ms median absolute error) unless forced.
   - Labels:
     - Frame grid at `hop_length` (128 or 64). Mark 8‑class labels at `time_sec + offset_sec`; apply ±K‑frame dilation.
     - Build an `onset_any` channel for the onset head (OR of all classes).
     - Persist event lists for evaluation (seconds & frame indices).
   - Sharding & caching:
     - Write shard files (`.npz` or WebDataset/Parquet) with spectrograms or raw audio choice (flag), frame labels, lengths, metadata.
     - Optionally precompute transient‑enhanced mels (reuse `create_transient_enhanced_spectrogram`).
   - Splits:
     - Stratify train/val/test by artist/title and charter; ensure genre/style variety; keep at least 300 songs for dev/test.

4) Model Architecture (deliverable: updated Lightning module)
   - Heads: add `onset_head` (binary), keep `class_head` (8‑way multilabel). Loss = `L_class + λ * L_onset` (λ≈0.5–1.0 initially).
   - Optional `offset_head`: regress fractional offset relative to patch center within ±K frames for detected onsets (Huber loss).
   - Minor backbone changes: allow smaller patch size and stride; keep parameter count similar.

5) Training Schedule (deliverable: training entry + checkpoints)
   - Stage A (Onset warmup): train onset head only to high recall.
   - Stage B (Full): initialize from A, train onset+classes jointly; include hard‑negative mining for ride/hat spill and tom vs cymbal confusions.
   - Domain mix: mix batches from `drums.ogg` and `song.ogg` (or Demucs) to generalize.
   - Early stopping on event‑level F1 and subdivision recall (64ths at 180–240 BPM).
   - Export per‑class calibration (temperatures/thresholds) into `class_thresholds.json`.

6) Inference Decode (deliverable: Charter improvements)
   - Use onset head to gate class logits; NMS per class; minimum inter‑onset spacing per class (kick/snare 25–35 ms).
   - Apply per‑class constant offset correction; optional offset‑head adjustment.
   - Maintain tom↔cym arbitration with learned margin; keep configurable.

7) Acceptance Criteria (measured on dev set)
   - Kick/Snare: F1 ≥ 0.70 (or +0.25 absolute over baseline), P≥0.65, R≥0.70.
   - 32nd recall ≥ 0.65 at 180–220 BPM; 64th recall ≥ 0.45 at 180–220 BPM.
   - Cymbals: ride precision ≥ 0.55 with recall ≥ 0.50; hi‑hat/crash F1 ≥ 0.55.
   - Toms: precision ≥ 0.65 on tom‑heavy tracks with recall ≥ 0.55.
   - Timing: per‑class |median offset| < 5 ms; |mean| < 10 ms.

8) Risks & Mitigations
   - Label noise/desync: auto offset + dilation; drop worst offenders; robust losses.
   - Compute/memory at high res: use smaller patch size/stride; gradient checkpointing; shorter `max_audio_length` with chunking.
   - Domain mismatch (stems vs mix): train on both; light timbre augmentation.

Implementation Tasks
- Metrics
  - [ ] Add IOI/subdivision stats to `chart_hero.eval.evaluate_chart` and CSV.
  - [ ] Per‑class constant offset calibration tool and application.
- Config/Model
  - [ ] Add `local_highres` config (hop=128, patch_size=(8,16), stride=1, dilation=3, tolerance=3, focal loss on).
  - [ ] Add onset auxiliary head (+ optional offset head) in `transformer_model.py` + `lightning_module.py`.
- Dataset Builder
  - [ ] New module `chart_hero.train.build_dataset` reading `artifacts/clonehero_charts_json`.
  - [ ] Audio selection (drums.ogg→stems→song.ogg→Demucs) and global offset via xcorr.
  - [ ] Frame label writer with dilation and onset_any channel; shard writer.
  - [ ] Train/val/test splitting utilities (by artist/title/charter).
- Preparation & Data Quality
  - [ ] Loudness normalize audio to a reference (e.g., -14 LUFS) before feature extraction for stable dynamics across charts.
  - [ ] Detect/skip desynced charts: residual MAE > 30 ms after offset; flag tempo anomalies; optional DTW alignment for borderline cases.
  - [ ] Duplicate/near‑duplicate detection using audio hashes; dedupe across difficulty variants from the same source.
  - [ ] Stem domain balancing: ensure each batch mixes “drums.ogg” and “song.ogg” (or Demucs) with a fixed ratio.
  - [ ] Genre/tempo stratification to guarantee high‑BPM and tom/ride‑heavy material in every epoch.
- Training
  - [ ] Training entry (`chart_hero.model_training.train_highres`) with staged training and checkpoints.
  - [ ] Calibration export (`class_thresholds.json`) and validator that prints the IOI/subdivision dashboard.
- Inference
  - [ ] Decode using onset gating + min spacing; apply offset corrections.
  - [ ] Two presets (conservative/aggressive) and CLI flags.

Additional Training Enhancements
--------------------------------

Architecture
- Onset auxiliary head (binary) + class head (8‑way); optional offset regression head (predict fractional position within ±K frames) to attain sub‑frame placement without shrinking hop further.
- Multi‑resolution features: concatenate mel features at two hops (e.g., 64 and 128) or use a small Conv front‑end that aggregates multiple receptive fields before the transformer.
- Local attention (chunked self‑attention) if sequence length at 2.9 ms becomes heavy; or use a conformer/CRNN hybrid for stronger local temporal modeling.

Objectives & Losses
- Label dilation ±2–3 frames at the chosen hop; event‑tolerance patches 2–3.
- Focal loss with capped positive weighting; optionally symmetric/bootstrapped CE for robustness.
- Pairwise ranking loss for tom vs cymbal on the same color (encourage a margin), to complement the decode‑time arbitration margin.
- Offset regression (Huber) trained only around positive windows to refine timing.

Sampling & Curriculum
- Class/tempo/IOI balancing: oversample ride‑heavy, tom‑heavy, and high‑BPM windows; under‑sample easy 4‑on‑the‑floor.
- Curriculum by IOI: start with 16th/8th dominant material; progressively include more 32nd/64th‑dense windows.
- Hard‑negative mining: periodically collect recent false positives (e.g., ride spill or snare ghost) and upweight them.

Augmentation
- SpecAugment (already on), light time‑stretch (±3–6%) with tempo map compensation for labels; pitch/timbre jitter for kit variance; small dynamic EQ.
- Mix domain jitter: random cross‑fade between drums.ogg and song.ogg; optional additive crowd noise/reverb at low SNR.

Calibration & Thresholding
- Learn per‑class temperatures/thresholds on a dev set; save to checkpoint (`class_thresholds.json`) and apply at decode.
- Learn constant per‑class offset corrections on dev; apply during inference to keep medians near 0 ms.

Compute on a Laptop
- Smaller hidden size/heads, gradient checkpointing, chunked sequences (`max_audio_length` shorter), and aggressive accumulation to keep VRAM/CPU RAM within limits.
- Pilot on ~300 songs to validate metrics, then scale up; snapshot every N hours to avoid long reruns.


Integration With Existing Export Script
- `scripts/export_clonehero_drums_archives.py` produces JSON with `path` pointing to the true CH song folder.
- The dataset builder will resolve audio by `song_dir = Path(doc['path']).parent` and prefer `drums.ogg` or stems, else `song.ogg`.
- It will trust `events[*].time_sec` but also re-derive seconds from `timing`/`tpq` to detect inconsistencies (warn or fix).

Timeline (rough)
- Week 1: Metrics, high‑res config, dataset builder prototype on ~300 songs; quick pilot train.
- Week 2: Onset/offset heads; full dataset run (thousands); calibration; evaluator dashboards; iterate.
- Week 3: Integrate decode changes; presets; export/playtest; finalize thresholds; write docs.
